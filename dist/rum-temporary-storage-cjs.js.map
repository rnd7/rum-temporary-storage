{"version":3,"file":"rum-temporary-storage-cjs.js","sources":["../src/index.js"],"sourcesContent":["import Storage from '@rnd7/rum-storage'\nconsole.log(Storage)\n\nexport const TEMPORARY_STORAGE_DEFAULTS = {\n  scheduler: true,\n  ttl: 1000*60*60*24,\n  minWipeInterval: 1000*60,\n  touchOnFind: true,\n  touchOnList: true\n}\n\nexport class TemporaryStorage extends Storage {\n    constructor(opts) {\n      super(opts)\n    }\n\n    _init() {\n      super._init()\n      this._touched = {}\n      this._wipe = this.wipe.bind(this)\n      this._scheduled\n      this._nextWipe\n      this._lastWipe\n    }\n\n    set scheduler(val) {\n      this._scheduler = val\n      if (!this._scheduler && this._scheduled){\n        this._scheduled = clearTimeout(this._scheduled)\n      } else if (!this._scheduled) {\n        this.wipe()\n      }\n    }\n\n    get scheduler() {\n      return this._scheduler\n    }\n\n    schedule(time) {\n      if (!this._scheduler) return\n      if (this._nextWipe > time) {\n        const now = Date.now()\n        this._nextWipe = Math.max(this._lastWipe + this.minWipeInterval, time)\n        if (this._scheduled)\n          this._scheduled = clearTimeout(this._scheduled)\n        if (this._nextWipe < Number.MAX_SAFE_INTEGER) {\n          this._scheduled = setTimeout(this._wipe, this._nextWipe - now)\n        }\n      }\n    }\n\n    wipe() {\n      const limit = Date.now() - this.ttl\n      let next = Number.MAX_SAFE_INTEGER\n      for (let sid in this._touched) {\n        let t = this._touched[sid]\n        if (t <= limit) this.remove(sid)\n        else if (t<next) next = t\n      }\n      this._lastWipe = now\n      this.schedule(next + this.ttl)\n    }\n\n    touch(sid) {\n      const now = Date.now()\n      this._touched[sid] = now\n      this.schedule(now + this.ttl)\n    }\n\n    insert(record) {\n      return super.insert(record).then(result=>{\n        this.touch(this.indexIn(record))\n        return result\n      })\n    }\n\n    list() {\n      return super.list().then(result=>{\n        if (this.touchOnList) for (let index of result) this.touch(index)\n        return result\n      })\n    }\n\n    find(recordOrIndex) {\n      return super.find(recordOrIndex).then(result=>{\n        if (this.touchOnFind) {\n          let index\n          if (typeof recordOrIndex === \"string\") index = recordOrIndex\n          else index = this.indexIn(recordOrIndex)\n          this.touch(index)\n        }\n        return result\n      })\n    }\n\n    update(record) {\n      return super.update(record).then(result=>{\n        this.touch(this.indexIn(record))\n        return result\n      })\n    }\n\n    upsert(record) {\n      const index = this.indexIn(record)\n      if (this._cache.hasOwnProperty(index)) return this.update(record)\n      return this.insert(record)\n    }\n\n    replace(record) {\n      return super.replace(record).then(result=>{\n        this.touch(this.indexIn(record))\n        return result\n      })\n    }\n\n    remove(recordOrIndex) {\n      let index\n      if (typeof recordOrIndex === \"string\") index = recordOrIndex\n      else index = this.indexIn(recordOrIndex)\n      return super.remove(recordOrIndex).then(result=>{\n        delete this._touched[index]\n        return result\n      })\n    }\n}\n"],"names":["console","log","Storage","TEMPORARY_STORAGE_DEFAULTS","scheduler","ttl","minWipeInterval","touchOnFind","touchOnList","TemporaryStorage","opts","_touched","_wipe","wipe","bind","_scheduled","_nextWipe","_lastWipe","time","_scheduler","now","Date","Math","max","clearTimeout","Number","MAX_SAFE_INTEGER","setTimeout","limit","next","sid","t","remove","schedule","record","then","result","touch","indexIn","index","recordOrIndex","_cache","hasOwnProperty","update","insert","val"],"mappings":"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"}