{"version":3,"file":"rum-temporary-storage-cjs.js","sources":["../src/index.js"],"sourcesContent":["import { Storage } from '@rnd7/rum-storage'\n\nexport const TEMPORARY_STORAGE_DEFAULTS = {\n  scheduler: true,\n  ttl: 1000*60*60*24,\n  touchOnFind: true,\n  touchOnList: true\n}\n\nexport class TemporaryStorage extends Storage {\n\n  constructor(opts) {\n    super(Object.assign({}, TEMPORARY_STORAGE_DEFAULTS, opts))\n    this._touched = {}\n    this._wipe = this.wipe.bind(this)\n    this._nextWipe = 0\n    this._lastWipe = 0\n  }\n\n  set scheduler(val) {\n    this._scheduler = val\n    if (!this._scheduler && this._scheduled){\n      this._scheduled = clearTimeout(this._scheduled)\n    } else if (!this._scheduled) {\n      this.wipe()\n    }\n  }\n\n  get scheduler() {\n    return this._scheduler\n  }\n\n  schedule(time) {\n    if (!this._scheduler) return\n    if (!this._nextWipe || this._nextWipe > time) {\n      const now = Date.now()\n      this._nextWipe = time //Math.max(this._lastWipe + this.minWipeInterval, time)\n      if (this._scheduled)\n        this._scheduled = clearTimeout(this._scheduled)\n\n      this._scheduled = setTimeout(this._wipe, this._nextWipe - now)\n    }\n  }\n\n  wipe() {\n    const now = Date.now()\n    const limit = now - this.ttl\n    let next = 0\n    for (let sid in this._touched) {\n      let t = this._touched[sid]\n      if (t <= limit) this.remove(sid)\n      else if ( next == 0 || t < next) next = t\n    }\n    this._nextWipe = 0\n    this._lastWipe = now\n    if (next) this.schedule(next + this.ttl)\n  }\n\n  touch(sid) {\n    const now = Date.now()\n    this._touched[sid] = now\n    this.schedule(now + this.ttl)\n  }\n\n  insert(record) {\n    return super.insert(record).then(result=>{\n      this.touch(this.indexIn(record))\n      return result\n    })\n  }\n\n  list() {\n    return super.list().then(result=>{\n      if (this.touchOnList) for (let index of result) this.touch(index)\n      return result\n    })\n  }\n\n  find(recordOrIndex) {\n    return super.find(recordOrIndex).then(result=>{\n      if (this.touchOnFind) {\n        let index\n        if (typeof recordOrIndex === \"string\") index = recordOrIndex\n        else index = this.indexIn(recordOrIndex)\n        this.touch(index)\n      }\n      return result\n    })\n  }\n\n  update(record) {\n    return super.update(record).then(result=>{\n      this.touch(this.indexIn(record))\n      return result\n    })\n  }\n\n  upsert(record) {\n    const index = this.indexIn(record)\n    if (this._cache.hasOwnProperty(index)) return this.update(record)\n    return this.insert(record)\n  }\n\n  replace(record) {\n    return super.replace(record).then(result=>{\n      this.touch(this.indexIn(record))\n      return result\n    })\n  }\n\n  remove(recordOrIndex) {\n    let index\n    if (typeof recordOrIndex === \"string\") index = recordOrIndex\n    else index = this.indexIn(recordOrIndex)\n    return super.remove(recordOrIndex).then(result=>{\n      delete this._touched[index]\n      return result\n    })\n  }\n}\n"],"names":["TEMPORARY_STORAGE_DEFAULTS","scheduler","ttl","touchOnFind","touchOnList","TemporaryStorage","opts","Object","assign","_touched","_wipe","wipe","bind","_nextWipe","_lastWipe","time","_scheduler","now","Date","_scheduled","clearTimeout","setTimeout","limit","next","sid","t","remove","schedule","record","then","result","touch","indexIn","index","recordOrIndex","_cache","hasOwnProperty","update","insert","val","Storage"],"mappings":"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"}